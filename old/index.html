<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Raphaël · Image Rotation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/460/fabric.min.js"
        integrity="sha512-ybPp3kCrNQXdvTfh99YLIdnajWnQvHuEKDJ+b26mxI9w+pLhnBo3HmNLJ1pEUBFO1Q0bfJxApeqecNbmaV763g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        function vhToPixels(vh) {
            return Math.round(window.innerHeight / (100 / vh));
        }
        function getMeta(url) {
            var img = new Image();
            img.onload = function () {
                alert(this.width + " " + this.height);
            };
            img.src = url;
        }
        window.onload = function () {
            // console.log(getMeta('./bd.jpg'));
            //console.log(vhToPixels(100));
            var canvas = new fabric.Canvas('c');
            //canvas.setDimensions({ width: 500, height: vhToPixels(100) });
            var imgElement = document.getElementById('my-image');
            /*var imgInstance = new fabric.Image(imgElement, {
                left: 100,
                top: 0,
                angle: 0,
                opacity: 1,
                cropY: 100
            });
            canvas.add(imgInstance);*/

            img = new fabric.Image(imgElement, {
                top: 0,
                left: 0,
                selectable: false
            })
            canvas.setWidth(imgElement.naturalWidth)
            canvas.setHeight(imgElement.naturalHeight)
            userClipPath = new fabric.Rect({
                width: imgElement.naturalWidth, // 圖片原始大小
                height: imgElement.naturalHeight,
                fill: 'rgb(178, 178, 178, 0.4)',
            })
            canvas.add(img)
            canvas.add(userClipPath)
            let nowClip = {
                x: 0,
                y: 0
            }

            function clipImage() {
                console.log('clip!')
                const newImgCrop = userClipPath.getBoundingRect()
                console.log(newImgCrop)
                canvas.setWidth(newImgCrop.width)
                canvas.setHeight(newImgCrop.height)
                img.set({
                    cropX: newImgCrop.left + nowClip.x,
                    cropY: newImgCrop.top + nowClip.y,
                    width: newImgCrop.width,
                    height: newImgCrop.height
                })
                // 校正位置
                nowClip.x += newImgCrop.left
                nowClip.y += newImgCrop.top
                userClipPath.set({
                    left: 0,
                    top: 0
                })
                userClipPath.setCoords()
                canvas.renderAll()
            }

            document.getElementById('clipImage').addEventListener("onclick", function () { clipImage(); });
        };
    </script>
</head>

<body>
    <canvas id="c"></canvas>
    <img style="display:none;" src="./bd.jpg" id="my-image">
    <button id="clipImage">clipImage()</button>
</body>

</html>